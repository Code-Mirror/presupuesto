<script>
  $(function () {
    // Helper functions to set the totals panel
    // TODO: This is duplicated in entities/show_script.html. Must combine! Ongoing part of #364
    function setEconomicTotals(breakdown, columnDef, classSelector) {
      var format = function(amount) { return columnDef.render(amount, 'display', breakdown); },
          totalNonFinancial = totalFinancial = 0;

      $.each(breakdown.sub, function(id, value) {
        var amount = columnDef.data(breakdown.sub[id]);
        if ( id[0]==='8' || id[0]==='9' )
          totalFinancial += amount
        else
          totalNonFinancial += amount
      });

      if ( !includeFinancialChapters )
        $("#non-financial-total "+classSelector+"-amount").text(format(totalNonFinancial));
      $("#main-total "+classSelector+"-amount").text(format(totalNonFinancial+totalFinancial));
    }


    //
    // GRID RENDERING
    //
    
    // Shows the uid next to an item
    function fullIdFormatter(row, cell, value, columnDef, dataContext) {
      var fullName = (value||'') + " (" + dataContext.key + ")";
      return rowNameFormatter(row, cell, fullName, columnDef, dataContext);
    };

{% if is_chapter %}
    // Convert an article name into a link
    function articleLinkFormatter(value, type, item) {
      if ( item.indent==0 )
        return rowNameFormatter(value, type, item);

      var getIncomeLink = {{ 'getCountyIncomeLink' if is_county else 'getTownIncomeLink' }};
      var getExpenseLink = {{ 'getCountyExpenseLink' if is_county else 'getTownExpenseLink' }};
      var getLink = (uiState.view == 'expense') ? getExpenseLink : getIncomeLink;
      var link = getLink('{{ entity.slug }}', item.key);
      var linkedValue = "<a href='"+link+"'>"+value+"</a>";
      return rowNameFormatter(value, type, item);
    };
{% endif %}

    function getColumnDefinition(uiState) {
      var getBreakdownValue = getBreakdownValueFunction(uiState.field, uiState.year);
      return {
{% if show_actual %}
        title: "{{ _('Presupuestado') }}",
{% else %}
        title: uiState.field=='expense' ? "{{ _('Gastos') }}" : "{{ _('Ingresos') }}",
{% endif %}
        data: getBreakdownValue,
        render: getFormatter(uiState.format, stats, Number(uiState.year), getBreakdownValue)
      }; 
    }

    function getExecutionColumnDefinition(uiState) {
      var columnDef = getColumnDefinition(uiState);
      var title = uiState.field == 'expense' ? '{{ _("Gastado") }}' : '{{ _("Ingresado") }}';
      columnDef.title = getExecutionColumnName(budgetStatuses[uiState.year], title, budgetStatusLabels);
      columnDef.data = getBreakdownValueFunction(uiState.field, "actual_" + uiState.year);
      return columnDef;
    }

    function getLabelColumnTitle(tab) {
      var titles = {
{% if is_chapter %}
        'economic': "{{ _('Artículo') }}",
{% else %}
        'economic': "{{ _('Concepto') }}",
{% endif %}
        'functional': "{{ _('Programa') }}",
        'institutional': "{{ _('Entidad') }}",
        'funding': "{{ _('Fondo') }}"
      };
      return titles[tab];
    }

    function getLabelColumnRender(tab) {
      var renders = {
{% if is_chapter %}
        'economic': articleLinkFormatter,
{% else %}
        'economic': rowNameFormatter,
{% endif %}
{% if full_breakdown %}
  {% if programme_id %}
        'functional': getPolicyLinkFormatter(-1), // Subprogrammes at root level
  {% elif policy_uid %}
        'functional': getPolicyLinkFormatter(0),  // Programmes at root level
  {% else %}  // Showing an article
        'functional': getPolicyLinkFormatter(1),  // Policies at root level
  {% endif %}
{% else %}
        'functional': rowNameFormatter
{% endif %}
        'institutional': rowNameFormatter,
        'funding': rowNameFormatter
      };
      return renders[tab];
    }


    //
    // POLICY DATA
    //
    var stats = {{ stats|safe }};
    var budgetStatuses = {{ budget_statuses|safe }};
    var budgetStatusLabels = {
      '1T': '{{ _("hasta el primer trimestre") }}',
      '2T': '{{ _("hasta el segundo trimestre") }}',
      '3T': '{{ _("hasta el tercer trimestre") }}',
      'D': '{{ _("a día de hoy") }}',
      'PR': '{{ _("proyecto") }}'
    };

{% if include_financial_chapters %}
    var includeFinancialChapters = true;
{% else %}
    var includeFinancialChapters = false;
{% endif %}

    // The income and expense descriptions for the economic breakdowns do not match,
    // i.e. the same code, '2', means different things for income and expenses, so
    // we need to use the right descriptions
    var breakdowns = {
      'economic':       {{ economic_breakdown.to_json( labels=descriptions[show_side] )|safe if economic_breakdown else 'null' }},
      'functional':     {{ functional_breakdown.to_json( labels=descriptions['functional'] )|safe if functional_breakdown else 'null'  }},
      'institutional':  {{ institutional_breakdown.to_json( labels=descriptions['institutional'] )|safe if institutional_breakdown else 'null'  }},
      'funding':        {{ funding_breakdown.to_json( labels=descriptions['funding'] )|safe if funding_breakdown else 'null'  }}
    }

    // Grid Data onjets
    var gridData = {};
    $.each(breakdowns, function(name, b) { gridData[name] = breakdownToTable(b); });

    // Areas Data object
    var areasData = {
      'economic':       {{ (expense_areas if show_side=='expense' else income_areas)|safe }},
      'functional':     {{ functional_areas|safe if functional_areas else 'null' }},
      'funding':        {{ funding_areas|safe if funding_areas else 'null' }},
    };
    

    //
    // SETTING ELEMENTS
    //
    var myGrid,
        uiState       = null,
        currentChart  = null,
        i18n          = { 
          'budgeted': '{{ _("Presupuestado.StackedArea") }}',
          'proposed': '{{ _("Proyecto.StackedArea") }}'
        };

    //Update Tab
    function updateTab() {
      uiState = getUIState();
      
      // Update current tab (if is not widget)
      if (!$('body').hasClass('widget')) {
        $('#tabs .active').removeClass('active');
        $('a[href="#'+uiState.view+'"]').blur().parent().addClass('active');
      // Setup widget tab title
      } else {
        $('.tab-title h3.'+uiState.view).show();
      }
      redraw();
    }

    // Update Year
    function updateYear() {
      uiState = getUIState();
      redrawGrid()
    }

    // Redraw all
    function redraw(){
      uiState = getUIState();
    
      // Show/hide panel downloads
      $('.panel-downloads > p').hide();
      $('#'+uiState.view+'-downloads').show();

      redrawChart();
      redrawGrid();
    }

    // Do all the hard work of drawing the grids
    function redrawGrid() {
      if( $('#myGrid').size() == 0 ) return;

      // Do work
      var columnDef = getColumnDefinition(uiState);
      var executionColumnDef = getExecutionColumnDefinition(uiState);
      var addEconomicCategoriesPrefix = {{ 'true' if add_economic_categories_prefix else 'false' }};

      if ( myGrid !== undefined ) myGrid.destroy();

      myGrid = createBudgetGrid( "#myGrid", gridData[uiState.view], [
                          {
                            data: addEconomicCategoriesPrefix && uiState.view=='economic' ?
                                    addEconomicCategoryPrefix :
                                    'label',
                            title: getLabelColumnTitle(uiState.view),
                            render: getLabelColumnRender(uiState.view),
                          },
                          columnDef
{% if show_actual %}
                          ,executionColumnDef
{% endif %}
                        ]);

      // Update totals texts
      $('#totals-year').text(uiState.year);
      var label = uiState.view == 'income' ? '{{ _("Ingresado") }}' : '{{ _("Gastado") }}';
      $('#totals-panel .total-executed > span').html( label );
      var executionLabelPostfix = getExecutionTotalLabel(budgetStatuses[uiState.year], budgetStatusLabels);
      $("#main-total .main-label").html('{{ _("Total") }} <strong>{{ name }}</strong>'+ executionLabelPostfix);

      // Show actual/budgeted split only when there's data available
      // (and the field format is not '% of total', gets confusing otherwise).
      // Note: total amounts were the same whichever way you break down the items, so any breakdown
      // would do... but this may change as part of ongoing #364
      var breakdown = breakdowns['economic'],
          hasActualData = breakdown[uiState.field]['actual_'+uiState.year];
      if ( hasActualData && uiState.format!='percentage' ) {
        $("#totals-panel .total-executed").show();
      } else {
        $("#totals-panel .total-executed").hide();
      }

      // We have two totals: non-financial/financial. Show non-financial panel only when needed
      if ( !includeFinancialChapters ) {
        $('#non-financial-total').show();
      }

      // Fill in the amounts in the totals. Part of ongoing #364
      setEconomicTotals(breakdown, columnDef, '.total-budgeted');
      if ( hasActualData )
        setEconomicTotals(breakdown, executionColumnDef, '.total-executed');

      // Set total values
      var getTotal = function(breakdown) { return columnDef.data(breakdown)||0; },
          getActualTotal = function(breakdown) { return executionColumnDef.data(breakdown)||0; },
          format = function(amount) { return columnDef.render(amount, 'display', breakdown); },
          formatActual = function(amount) { return executionColumnDef.render(amount, 'display', breakdown); };

      if ( hasActualData ) {
        $("#main-total .total-executed-amount").text(formatActual(getActualTotal(breakdown)));
        $("#main-total .total-budgeted-amount").text(format(getTotal(breakdown)));
      } else {
        $("#main-total .total-budgeted-amount").text(format(getTotal(breakdown)));
      }

      // Handle the hash the page may have loaded with.
      var state = $.deparam.fragment();
      if ( state.item ) { // Highlight a particular item
        unfoldItem( gridData[uiState.view], state.item );
        window.setTimeout(function() {
          $('html, body').animate({ scrollTop: $('#myGrid').offset().top }, 500);
        }, 1000);
      }
    }

    function redrawChart() {
      if (uiState === null) return;

      // We skip chart setup in institutional tab
      if (uiState.view === 'institutional'){
        $('#policy-chart-container .stacked-area-chart').remove();
        $('#policy-chart-container .stacked-area-chart-legend').remove();
        $('.policies-chart').hide();
        return;
      } else {
        $('.policies-chart').show();
      }

      // Setup Graph
      var colorScale = {{ color_scale|safe }};
      var labelsMinSize = {{ treemap_labels_min_size|safe }};

      // Setup treemap chart
      {% if show_treemap %}
      if (currentChart !== null) $('#policy-chart-container .treemap-chart').remove();
      currentChart = new BudgetTreemap('#policy-chart-container', breakdowns[uiState.view], stats, areasData[uiState.view], 2, colorScale, labelsMinSize)
        .i18n(i18n)
        .maxLevels(2)
        .budgetStatuses(budgetStatuses);
      currentChart.createTreemap( uiState );
      // Add area click event
      if (uiState.view == 'functional') {
        $('#policy-chart-container').bind('policy-selected', onItemSelected);
      } else {
        $('#policy-chart-container .treemap-chart rect').css('cursor', 'auto');
      }

      // Setup stacked area chart
      {% else %}
      currentChart = new BudgetStackedChart('#policy-chart-container', stats, colorScale, i18n)
        .budgetStatuses(budgetStatuses);
      currentChart.loadBreakdown(breakdowns[uiState.view], uiState.field);
      currentChart.draw( uiState );
      // Add area click event if type is functional
      if (uiState.view == 'functional') {
        $('#policy-chart-container .stacked-area-chart').addClass('clickable');
        $('#policy-chart-container').bind('area-selected', onItemSelected);
      }
      {% endif %}
    };

    // Link to policy handlers
    function onItemSelected(event, d) {
      // Avoid link in other tabs different from functional
      if (uiState.view != 'functional') return;

      var widget = $('body').hasClass('widget') ? '?widget=1' : '';
      var label = (event.view == 'policy-selected') ? d.name : d.label;

{% if article %}
      window.location = getPolicyLink(d.id, label, getUIState())+widget;
{% elif policy_uid %}
      window.location = getProgrammeLink(d.id, label, getUIState())+widget;
{% else %}
      window.location = getSubprogrammeLink(d.id, label, getUIState())+widget;
{% endif %}
    }

    // Control Setup
    $('#select-format').change(redraw);
    initSlider("#year-selection", {{ years|safe }}, updateYear, {{ latest_year }});

    // Setup tabs navigation
    setRedrawOnTabsChange('#tabs', updateTab);

    // Add click embed btn event
    $('.chart-container .chart-embed-btn').click(function(e){
      e.preventDefault();
      var url   = window.location.protocol+'//'+window.location.host+window.location.pathname+'?widget=1'+window.location.hash;
      var code  = '<iframe src="'+url+'" width="100%" scrolling="no" marginheight="0" frameborder="0"></iframe><\script type="text/javascript" src="'+window.location.origin+'/static/javascripts/iframeResizer.min.js"\>\<\/script\>\<script type="text/javascript"\>iFrameResize();\<\/script\>';
      $('#modal-embed .modal-body textarea').val( code );
    });
  })
</script>