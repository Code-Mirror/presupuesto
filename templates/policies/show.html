{% extends 'base.html' %}
{% from 'shared/breakdown_tab.html' import render_tab as render_tab %}

{% block extra_javascript %}
<script src="{{ STATIC_URL }}javascripts/vis/d3.v3.min.js"></script>
{% if show_treemap %}
<script src="{{ STATIC_URL }}javascripts/vis/bigtext.js"></script>
<script src="{{ STATIC_URL }}javascripts/vis/budget-treemap.js"></script>
{% else %}
<script src="{{ STATIC_URL }}javascripts/vis/stacked-area-chart.js"></script>
<script src="{{ STATIC_URL }}javascripts/vis/budget-stacked-chart.js"></script>
{% endif %}
{% endblock %}

{% block content %}

<!-- Politicas Detalle -->
<section class="policies policy-breakdown" role="region" data-field="{{ show_side }}">

  <!-- Politicas Header -->
  <div class="policies-header section-header">

    <div class="container">
      {% if programme %}
      <p class="history-back">
        <a href="{% url 'budget_app.views.policies_show' programme.policy, policy.slug() %}" id="policy-name-link">
          &larr; {{ descriptions['functional'].get(programme.policy) }}
        </a>
      </p>
      <h2 class="page-title">{{ name }}</h2>
      {% else %}
      <p class="history-back">
        <a href="{{ url(show_entity_url, entity.slug) if entity else url('budget_app.views.policies') }}">&larr; {{ _('Volver a Políticas') }}</a>
      </p>
      <h2 class="page-title">{{ entity.name+': ' if entity }}{{ name }}</h2>
      {% endif %}

      <!-- TODO!!! Check if we need this lines -->
      <h2 class="hidden">{{ _('Programas, entidades y conceptos') }}</h2>
      <h2 class="hidden">{{ _('Menú de programas, entidades y conceptos') }}</h2>
    </div>

    <ul id="tabs" class="nav nav-tabs nav-tabs-centered" role="tablist">
    {% if full_breakdown %}
      {% if programme is not defined and show_side != 'income' %}
      <li class="active">
        <a href="#functional" title="{{ _(tab_titles['functional']) }}">
          <h3>{{ _(tab_titles['functional']) }}</h3>
        </a>
      </li>
      <li>
        <a href="#economic" title="{{ _(tab_titles['economic']) }}">
          <h3>{{ _(tab_titles['economic']) }}</h3>
        </a>
      </li>
      {% else %}
      <li class="active">
        <a href="#economic" title="{{ _(tab_titles['economic']) }}">
          <h3>{{ _(tab_titles['economic']) }}</h3>
        </a>
      </li>
      {% endif %}
      {% if show_funding_tab %}
      <li>
        <a href="#funding" title="{{ _(tab_titles['funding']) }}">
          <h3>{{ _(tab_titles['funding']) }}</h3>
        </a>
      </li>
      {% endif %}
      {% if show_institutional_tab %}
      <li>
        <a href="#institutional" title="{{ _(tab_titles['institutional']) }}">
          <h3>{{ _(tab_titles['institutional']) }}</h3>
        </a>
      </li>
      {% endif %}
    {% else %}
      {% if policy_uid %}
      <li class="active">
        <a href="#functional" title="{{ _(tab_titles['functional']) }}">
          <h3>{{ _(tab_titles['functional']) }}</h3>
        </a>
      </li>
      {% else %}
      <li class="active">
        <a href="#economic" title="{{ _(tab_titles['economic']) }}">
          <h3>{{ _(tab_titles['economic']) }}</h3>
        </a>
      </li>
      {% endif %}
    {% endif %}
    </ul>
  </div>

  <!-- Policies Content -->
  <div class="policies-content">
    <div class="container tab-content">

  {% if full_breakdown %}
    {% if programme is not defined and show_side != 'income' %}
      {{ render_tab(_(tab_titles['functional']), 'functional', true, csv_type, csv_id, 'active') }} 
      {{ render_tab(_(tab_titles['economic']), 'economic', true, csv_type, csv_id, '') }}
    {% else %}
      {{ render_tab(_(tab_titles['economic']), 'economic', true, csv_type, csv_id, 'active') }} 
    {% endif %}
    {% if show_funding_tab %}
      {{ render_tab(_(tab_titles['funding']), 'funding', true, csv_type, csv_id, '') }} 
    {% endif %}
    {% if show_institutional_tab %}
      {{ render_tab(_(tab_titles['institutional']), 'institutional', true, csv_type, csv_id, '') }} 
    {% endif %}
  {% else %}
      {# The download links for small entities are too cumbersome to calculate in the macro #}
    {% if policy_uid %}
      {% set download_view_name = 'budget_app.views.entity_article_fexpenses' %}
      {{ render_tab(_(tab_titles['functional']), 
                    'functional',
                    true,
                    csv_type, 
                    csv_id, 
                    'active', 
                    csv_link=url(download_view_name, level, entity.slug, csv_id, 'csv'),
                    xls_link=url(download_view_name, level, entity.slug, csv_id, 'xls') ) }} 
    {% else %}
      {% set download_view_name = 'budget_app.views.entity_article_expenses' if show_side=='expense' 
                                  else 'budget_app.views.entity_article_income'%}
      {{ render_tab(_(tab_titles['economic']), 
                    'economic',
                    true,
                    csv_type, 
                    csv_id, 
                    'active', 
                    csv_link=url(download_view_name, level, entity.slug, csv_id, 'csv'),
                    xls_link=url(download_view_name, level, entity.slug, csv_id, 'xls') ) }} 
    {% endif %}
  {% endif %}

      <table class="table-grid" id='myGrid' width='100%'></table>
    </div>
  

    {% include 'shared/social_sharing.html' %}
  </div>
</section>

<!-- 
  We render the control panel here initially, and move it to the active tab at run-time.
  Having multiple control panels would mean having to sincronize them, messy.
-->
<div class="hidden">
{% include 'shared/data_controllers.html' %}
</div>

<!-- Same story with the totals -->
<div class="hidden">
  {% include 'entities/totals.html' %}
</div>


{% if show_treemap %}
<div id="pop-up">
  <div id="pop-up-title"></div>
  <div id="pop-up-content"></div>
</div>
{% endif %}

{% include 'shared/modal_embed.html' %}

{% include 'shared/data_sources.html' %}
{% include 'shared/policy_paths.html' %}
{% include 'policies/policies_javascript.html' %}

{% endblock %}