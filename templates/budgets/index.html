{% extends 'base.html' %}

{% block extra_javascript %}
<script src="{{ STATIC_URL }}javascripts/vis/d3.v3.min.js"></script>
<script src="{{ STATIC_URL }}javascripts/vis/d3.sankey.js"></script>
<script src="{{ STATIC_URL }}javascripts/vis/budget-sankey.js"></script>
{% endblock %}

{% block content %}

<!-- Budget Stream Intro -->
{% include 'budgets/budgets_intro.html' %}

<!-- Budget Sankey Viz -->
<div class="budget-viz">
  <div class="container">
    <h2 class="page-title">{{ _('Ingresos y gastos en el Gobierno de Aragón') }}</h2>

    <div class="sankey-container">
      <div class="sankey chart-container" id="chart">
        <div id="pop-up" class="popover top" role="tooltip">
          <div class="arrow"></div>
          <h4 class="popover-title"></h4>
          <div class="popover-content"></div>
        </div>
      </div>

      <div class="data-controllers">
        <p class="title">{{ _('Elige año') }}</p>
        <div class="layout-slider">
          <input id="year-selection" type="slider" name="price" value="20" />
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Budget Data -->
<div id="budgets-totals" class="budget-data">
  <div class="container">

    <h2 class="page-title" id="indicadores">{{ _('Datos presupuestarios en') }} <span id="totals-year"></span></h2>
    
    <div id="totals-panel" class="data-panel">

      <!-- Budget Total Incomes -->
      <div class="panel total-incomes">
        <div class="panel-title">{{ _('Ingresos totales') }}</div>
        <div class="panel-content">
          <p class="total-executed">
            <span>{{ _('Ejecutado') }}</span> <b id="total-incomes-executed"></b>
          </p>
          <p class="total-budgeted">
            <span>{{ _('Presupuestado') }}</span> <b id="total-incomes-budgeted"></b>
          </p>
        </div>
      </div>

      <!-- Budget Total Expenses -->
      <div class="panel total-expenses">
        <div class="panel-title">{{ _('Gastos totales') }}</div>
        <div class="panel-content">
          <p class="total-executed">
            <span>{{ _('Ejecutado') }}</span> <b id="total-expenses-executed"></b>
          </p>
          <p class="total-budgeted">
            <span>{{ _('Presupuestado') }}</span> <b id="total-expenses-budgeted"></b>
          </p>
        </div>
      </div>

      <!-- Budget Indicators -->
      {% include 'budgets/budgets_indicators.html' %}

    </div>

    <p class="text-center"><small>{{ _('Cantidades actualizadas con la inflación a fecha 1 de enero de') }} {{ last_inflation_year }}. {{ _('El cálculo de los indicadores utiliza las cifras del presupuesto aprobado') }}.</small></p>
    {% if not include_financial_chapters %}
    <p class="text-center"><small>{{ _('Se incluyen únicamente los gastos e ingresos no financieros, es decir, capítulos I al VII.') }}</small></p>
    {% endif %}

    <!-- Social Sharing Buttons -->
    {% include 'shared/social_sharing.html' %}
  </div>
</div>

<!-- Data Sources Panel -->
{% include 'shared/data_sources.html' %}


{% include 'shared/policy_paths.html' %}

<script>
  $(function() {
    function redraw() {
      var uiState = getUIState();
      sankey.update(uiState);
      updateIndicators(uiState);
    }

    {% include 'budgets/budgets_update_indicators.html' %}

    // Calculate maximum amount to display across all years, so we can set a global scale for the Sankey
    function calculateMaximumSankeyAmount(breakdown, stats) {
      var highest_amount = 0;
      for (var column in breakdown.years) {
        var year = breakdown.years[column].toString();
        var highest_this_year = Math.max( 
                                  (breakdown.income[year]||0), 
                                  (breakdown.income['actual_'+year]||0),
                                  (breakdown.expense[year]||0), 
                                  (breakdown.expense['actual_'+year]||0) );
        var highest_amount = Math.max(highest_amount, 
                                      adjustInflation(highest_this_year, stats, breakdown.years[column]));
      }
      return highest_amount;
    }

    var stats = {{ stats|safe }};
    var budgetStatuses = {{ budget_statuses|safe }};

    var functionalBreakdown = {{ functional_breakdown.to_json( labels=descriptions['functional'] )|safe }};
    var economicBreakdown = {{ economic_breakdown.to_json( labels=descriptions['income'] )|safe }};
    var chapterBreakdown = {{ chapter_breakdown.to_json()|safe }};  // Used for indicators
    var i18n = {
      'other': '{{ _("Otros") }}',
      'government': '{{ _("Gobierno de Aragón") }}',
      'budgeted': '{{ _("Presupuestado") }}',
      'executed': '{{ _("Ejecutado") }}',
      '1T': '{{ _("hasta el primer trimestre") }}',
      '2T': '{{ _("hasta el segundo trimestre") }}',
      '3T': '{{ _("hasta el tercer trimestre") }}',
      'D': '{{ _("a día de hoy") }}',
      'amounts.are.real': '{{ _("(Cantidades actualizadas con la inflación)") }}',
      'n/d': 'No hay datos'
    };

    var sankey = new BudgetSankey(functionalBreakdown, economicBreakdown, stats, budgetStatuses, i18n);
    sankey.incomeNodes({{ income_nodes|safe }});
    sankey.expenseNodes({{ expense_nodes|safe }});
    // Set a constant scale for the Sankey diagram across the years (otherwise each year would look
    // equally big). Note: 4% margin to avoid clipping, as there is some spacing between the items.
    sankey.maxAmountEver( calculateMaximumSankeyAmount(functionalBreakdown, stats) * 1.04 );  

    initSlider("#year-selection", {{ years|safe }}, redraw, {{ latest_year }});
    sankey.draw("#chart", getUIState());
    redraw();
  })
</script>

{% endblock %}