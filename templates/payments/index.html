{% extends 'base.html' %}
{% from 'shared/payment_tab.html' import render_tab as render_tab %}
{% block content %}
<div class="container">
  
</div>

<section class="payments-breakdown" role="region">

  <!-- Payments Header -->
  <div class="payments-header section-header">

    <div class="container">
      <h2 class="page-title">{{ _('Inversiones y pagos') }}</h2>
    </div>

    <ul id="tabs" class="nav nav-tabs nav-tabs-centered" role="tablist">
      <li class="active">
        <a href="#tab-area"><h3>{{ _('Por área') }}</h3></a>
      </li>
      <li>
        <a href="#tab-payee"><h3>{{ _('Por beneficiario') }}</h3></a>
      </li>
    </ul>
  </div>

  <div class="payments-content">
    <div class="container tab-content">
      
      {% include 'payments/payments_intro.html' %}
      
      <div class="data-controllers">
        <p class="title tcenter">{{ _('Elige año') }}</p>
        <div class="layout-slider">
          <input id="year-selection" type="text" />
        </div>
      </div>

      <div id="totals_panel" class="totals-placeholder data-panel">
        <div class="panel">
          <div class="panel-content">
            <p class="total"><span>{{ _('Total de inversiones y pagos') }}</span> <b id="total"></b></p>
          </div>
        </div>
      </div>

      <table class="table-grid" id='myGrid' width="100%"></table>

      {{ render_tab(_('Por área'), 'area', 'active', entity) }}
      {{ render_tab(_('Por beneficiario'), 'payee', '', entity) }}

      {% include 'shared/social_sharing.html' %}
    </div>
  </div>
</section>

{% include 'shared/data_sources.html' %}

<script>
  $(function () {
    //
    // GRID RENDERING
    //

    function getColumnDefinition(uiState) {
      return { 
        data: getBreakdownValueFunction('expense', uiState.year),
        title: '{{ _("Pago") }}',
        render: getFormatter('nominal', stats, Number(uiState.year))
      }; 
    }

    // Do all the hard work of drawing the grids
    function redrawGrid() {
      var uiState = getUIState();
      var columnDef = getColumnDefinition(uiState);

      var currentTab = $(".payments-breakdown .tab-pane.active").attr('id');
      var title = (currentTab == 'tab-area') ? '{{ _("Área") }}' : '{{ _("Beneficiario") }}';
      var data = (currentTab == 'tab-area') ? areaGridData : payeeGridData;

      if ( myGrid !== undefined )  myGrid.destroy();
      myGrid = createBudgetGrid("#myGrid", data,
                        [
                          {
                            data: "key",
                            title: title,
                            render: rowNameFormatter
                          },
                          columnDef
                        ]);

      // Total amounts are the same whichever way you break down the items, so any breakdown will do
      $("#total").text( columnDef.render(columnDef.data(payeeBreakdown) || 'n/a' ) );
    }    


    //
    // DATA
    //
    var payeeBreakdown = {{ payee_breakdown.to_json()|safe }};
    var payeeGridData = breakdownToTable(payeeBreakdown);

    var areaBreakdown = {{ area_breakdown.to_json()|safe }};
    var areaGridData = breakdownToTable(areaBreakdown);

    var years = {{ years|safe }};
    var stats = {{ stats|safe }};

    var myGrid;


    //
    // TABS
    //
    $('#tabs a').click(function (e) {
      e.preventDefault();
      $(this).tab('show');
      redrawGrid();
    });


    //
    // LOCATION HASH
    //

    // XXX: This method is very similar to the one for policies, but not quite the same :/
    function unfoldItem(gridData, itemId) {
      var found = false;
      for ( i=0; i<gridData.length && !found; i++ ) {
        // XXX: Not proud of this matching (both passing a description via URL and using indexOf
        // to match), but a) we don't have a better id at the moment, the breakdown only gives us
        // amounts and the dimension keys, and b) because of the former we've added the date to the
        // item description, so we can't get an exact match.
        if ( gridData[i].key.indexOf(itemId) == 0 ) {
          var parent = gridData[i].parent;
          while (parent != null) {
            parent._expanded = true;
            parent = parent.parent;
          }
          found = true;
        }
      }
      return found;
    }

    function parseLocationHash() {
      state = $.deparam.fragment();

      // Highlight a particular item
      if ( state.description ) {
        unfoldItem(payeeGridData, state.description);
        redrawGrid();
        $("a[href=#tab-payee]").click();
        window.setTimeout(function(){ $(".toggle.collapse")[0].scrollIntoView() }, 1000);

      } else {
        redrawGrid();
      }
    }

    initSlider("#year-selection", years, redrawGrid, {{ latest_year }});
    if (years.length==1) $(".data-controllers").hide();

    parseLocationHash();      // Handle the hash the page may have loaded with.
  })
</script>

{% endblock %}
